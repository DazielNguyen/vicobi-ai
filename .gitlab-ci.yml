image: docker:latest

services:
  - docker:dind

variables:
  AWS_REGION: "ap-southeast-1"
  ECS_CLUSTER: "Dev-Cluster"
  
  SERVICE_NAME: "ai-service"
  
  ECR_REPOSITORY: "vicobi/ai"
  
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

stages:
  - deploy

deploy_ai:
  stage: deploy
  timeout: 30m 
  
  before_script:
    - apk add --no-cache aws-cli jq
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY_URI
  
  script:
    - |
      echo "üöÄ Starting deploy for AI Service..."
      
      # --- 1. BUILD DOCKER IMAGE ---
      export IMAGE_TAG=$CI_COMMIT_SHORT_SHA
      export FULL_IMAGE_NAME=$ECR_REGISTRY_URI/$ECR_REPOSITORY:$IMAGE_TAG
      export LATEST_IMAGE_NAME=$ECR_REGISTRY_URI/$ECR_REPOSITORY:latest
      
      # Pull image c≈© v·ªÅ ƒë·ªÉ t·∫≠n d·ª•ng cache layer
      docker pull $LATEST_IMAGE_NAME || true
      
      echo "Building Image..."
      docker build \
        --cache-from $LATEST_IMAGE_NAME \
        -t $FULL_IMAGE_NAME \
        -t $LATEST_IMAGE_NAME .
      
      # --- 2. PUSH IMAGE ---
      echo "Pushing Image to ECR..."
      docker push $FULL_IMAGE_NAME
      docker push $LATEST_IMAGE_NAME
      
      # --- 3. UPDATE ECS SERVICE ---
      echo "Updating ECS Service '$SERVICE_NAME'..."
      
      # L·∫•y Task Family hi·ªán t·∫°i
      TASK_FAMILY=$(aws ecs describe-services --cluster $ECS_CLUSTER --services $SERVICE_NAME --query "services[0].taskDefinition" --output text | awk -F/ '{print $2}' | awk -F: '{print $1}')
      
      # L·∫•y n·ªôi dung Task Definition c≈©
      aws ecs describe-task-definition --task-definition $TASK_FAMILY --query taskDefinition > task-definition.json
      
      # Thay th·∫ø Image m·ªõi v√†o JSON
      jq --arg image "$FULL_IMAGE_NAME" '.containerDefinitions[0].image = $image' task-definition.json > new-task-definition.json
      
      # X√≥a c√°c tr∆∞·ªùng readonly
      cat new-task-definition.json | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' > final-task-definition.json
      
      # ƒêƒÉng k√Ω Task Def m·ªõi
      NEW_TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://final-task-definition.json --query 'taskDefinition.taskDefinitionArn' --output text)
      
      # Force Deploy
      aws ecs update-service --cluster $ECS_CLUSTER --service $SERVICE_NAME --task-definition $NEW_TASK_DEF_ARN --force-new-deployment
      
      echo "‚úÖ AI Service Deployed Successfully!"

  rules:
    - if: $CI_COMMIT_BRANCH == "main"