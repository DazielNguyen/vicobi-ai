image: docker:latest

services:
  - docker:dind

variables:
  AWS_REGION: "ap-southeast-1"
  ECS_CLUSTER: "Dev-Cluster"
  SERVICE_NAME: "ai-service"
  ECR_REPOSITORY: "vicobi/ai"
  TASK_DEF_FAMILY: "vicobi-ai"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

stages:
  - deploy

deploy_ai:
  stage: deploy
  timeout: 30m
  before_script:
    - apk add --no-cache aws-cli jq
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY_URI
  script:
    - |
      export FULL_IMAGE_NAME=$ECR_REGISTRY_URI/$ECR_REPOSITORY:latest
      
      docker pull $FULL_IMAGE_NAME || true
      docker build --cache-from $FULL_IMAGE_NAME -t $FULL_IMAGE_NAME .
      docker push $FULL_IMAGE_NAME
      
      aws ecs describe-task-definition --task-definition $TASK_DEF_FAMILY --query taskDefinition > task-definition.json
      jq --arg image "$FULL_IMAGE_NAME" '.containerDefinitions[0].image = $image' task-definition.json > new-task-definition.json
      cat new-task-definition.json | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' > final-task-definition.json
      
      NEW_TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://final-task-definition.json --query 'taskDefinition.taskDefinitionArn' --output text)
      aws ecs update-service --cluster $ECS_CLUSTER --service $SERVICE_NAME --task-definition $NEW_TASK_DEF_ARN --force-new-deployment

  rules:
    - if: $CI_COMMIT_BRANCH == "main"